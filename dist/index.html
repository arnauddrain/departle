<!DOCTYPE html>
<html lang="fr">
  <head>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;500;700&display=swap"
      rel="stylesheet"
    />

    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <meta name="description" content="Trouvez le département du jour" />

    <title>Departle</title>

    <!-- Google Tag Manager -->
    <script>
      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, "script", "dataLayer", "GTM-T59L3ZJ");
    </script>
    <!-- End Google Tag Manager -->

    <style type="text/css">
      * {
        font-family: "Roboto", sans-serif;
        color: white;
        border: none;
        box-sizing: border-box;
        font-weight: 100;
      }
      h1 {
        text-align: center;
        text-transform: uppercase;
      }
      header {
        border-bottom: 2px white solid;
      }
      body {
        background: rgb(153, 153, 153);
      }
      .container {
        margin: auto;
        max-width: 500px;
      }
      path {
        fill: white;
      }
      .department {
        height: 180px;
      }
      svg {
        height: 100%;
        margin: auto;
        display: block;
      }
      .answers {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .answers > * {
        border-radius: 4px;
        height: 32px;
      }
      .answer {
        background: rgb(84, 84, 84);
      }
      input[type="text"] {
        height: 32px;
        border-radius: 4px;
        color: black;
        padding: 5px 10px;
      }
      input[type="submit"] {
        background: red;
      }
      .input-group {
        display: flex;
        flex-direction: column;
        position: relative;
      }
      #suggestions {
        position: absolute;
        display: flex;
        flex-direction: column;
        width: 100%;
        gap: 4px;
        bottom: calc(32px + 4px);
        max-height: 200px;
        overflow: auto;
      }
      #suggestions > * {
        display: block;
        background: rgb(153, 153, 153);
        height: 32px;
        border-radius: 4px;
        padding: 5px 10px;
        border: solid white 2px;
        font-weight: 500;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript
      ><iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-T59L3ZJ"
        height="0"
        width="0"
        style="display: none; visibility: hidden"
      ></iframe
    ></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div class="container">
      <header>
        <h1>Departle</h1>
      </header>
      <div class="department">
        <svg viewBox="0 0 667 578" xml:space="preserve">
          <path id="department"></path>
        </svg>
      </div>
      <form class="answers" autocomplete="off">
        <div class="answer"></div>
        <div class="answer"></div>
        <div class="answer"></div>
        <div class="answer"></div>
        <div class="answer"></div>
        <div class="answer"></div>
        <div class="input-group">
          <div id="suggestions"></div>
          <input type="text" id="answer" placeholder="Département" />
        </div>
        <input type="submit" value="Deviner" />
      </form>
    </div>
    <script>
      "use strict";

      let isReady = false;
      let answers = [];
      let departments = [];
      let departmentNames = [];
      let department = null;

      const inputElement = document.getElementById("answer");
      const suggestionsElement = document.getElementById("suggestions");
      const formElement = document.getElementsByTagName("form")[0];

      // from https://stackoverflow.com/questions/27928/calculate-distance-between-two-latitude-longitude-points-haversine-formula
      function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
        var R = 6371; // Radius of the earth in km
        var dLat = deg2rad(lat2 - lat1); // deg2rad below
        var dLon = deg2rad(lon2 - lon1);
        var a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(deg2rad(lat1)) *
            Math.cos(deg2rad(lat2)) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        var d = R * c; // Distance in km
        return d;
      }

      function deg2rad(deg) {
        return deg * (Math.PI / 180);
      }

      function rad2deg(rad) {
        return rad / (Math.PI / 180);
      }

      // from https://stackoverflow.com/questions/3932502/calculate-angle-between-two-latitude-longitude-points
      function angleFromCoordinate(lat1, long1, lat2, long2) {
        const lat1r = deg2rad(lat1);
        const long1r = deg2rad(long1);
        const lat2r = deg2rad(lat2);
        const long2r = deg2rad(long2);
        const dLon = long2r - long1r;

        const y = Math.sin(dLon) * Math.cos(lat2r);
        const x =
          Math.cos(lat1r) * Math.sin(lat2r) -
          Math.sin(lat1r) * Math.cos(lat2r) * Math.cos(dLon);

        let brng = Math.atan2(y, x);
        brng = rad2deg(brng);
        brng = (brng + 360) % 360;

        return brng;
      }

      function getIconForDirection(angle) {
        const quarterOfCircle = 360 / 8;
        if (
          angle < quarterOfCircle / 2 ||
          angle > 360 - quarterOfCircle * 0.5
        ) {
          return "⬆";
        } else if (angle > 360 - quarterOfCircle * 1.5) {
          return "↖";
        } else if (angle > 360 - quarterOfCircle * 2.5) {
          return "⬅";
        } else if (angle > 360 - quarterOfCircle * 3.5) {
          return "↙";
        } else if (angle > 360 - quarterOfCircle * 4.5) {
          return "⬇";
        } else if (angle > 360 - quarterOfCircle * 5.5) {
          return "↘";
        } else if (angle > 360 - quarterOfCircle * 6.5) {
          return "➡";
        } else if (angle > 360 - quarterOfCircle * 7.5) {
          return "↗";
        }
      }

      async function fetchData() {
        const response = await fetch("departments.json");
        departments = (await response.json()).sort((a, b) =>
          a.name.localeCompare(b.name)
        );
        departmentNames = departments.map((d) => d.name);
        department =
          departments[Math.round(Math.random() * departments.length)];
        document
          .getElementsByTagName("svg")[0]
          .setAttribute("viewBox", department.viewBox);
        document
          .getElementsByTagName("path")[0]
          .setAttribute("d", department.path);
        isReady = true;
      }

      function guess(e) {
        e.preventDefault();
        if (!isReady) {
          return;
        }
        const answer = inputElement.value;
        inputElement.value = "";
        if (!departmentNames.includes(answer)) {
          return alert("Département inconnu !");
        } else {
          const guessedDepartment = departments.find((d) => d.name === answer);
          const distance = getDistanceFromLatLonInKm(
            guessedDepartment.coordinates.lat,
            guessedDepartment.coordinates.long,
            department.coordinates.lat,
            department.coordinates.long
          );
          const angle = angleFromCoordinate(
            guessedDepartment.coordinates.lat,
            guessedDepartment.coordinates.long,
            department.coordinates.lat,
            department.coordinates.long
          );
          const roundedDistance = Math.round(distance * 100) / 100;
          answers.push(guessedDepartment);
          document.getElementsByClassName("answer")[
            answers.length - 1
          ].innerHTML = `${
            guessedDepartment.name
          } (${roundedDistance}km ${getIconForDirection(angle)})`;
          if (answer === department.name) {
            alert("Vous avez gagné !");
          } else {
            if (answers.length === 6) {
              alert("Vous avez perdu...");
            }
          }
        }
      }

      function resetSuggestions() {
        suggestionsElement.innerHTML = "";
      }

      function autocomplete() {
        resetSuggestions();

        const answerLowerCase = inputElement.value.toLowerCase();
        departmentNames
          .filter((d) => d.toLowerCase().includes(answerLowerCase))
          .forEach((d) => {
            const element = document.createElement("div");
            element.appendChild(document.createTextNode(d));
            element.addEventListener("click", () => (inputElement.value = d));
            suggestionsElement.appendChild(element);
          });
      }

      fetchData();

      document.addEventListener("click", (e) => {
        e.target !== inputElement && resetSuggestions();
      });
      inputElement.addEventListener("keyup", autocomplete);
      inputElement.addEventListener("click", autocomplete);
      formElement.addEventListener("submit", guess);
    </script>
  </body>
</html>
