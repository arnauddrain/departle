<!DOCTYPE html>
<html lang="fr">
  <head>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;500;700&display=swap"
      rel="stylesheet"
    />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <meta name="description" content="Trouvez le département du jour" />
    <title>Departle</title>
    <style type="text/css">
      * {
        font-family: "Roboto", sans-serif;
        color: white;
        border: none;
        box-sizing: border-box;
        font-weight: 100;
      }
      h1 {
        text-align: center;
        text-transform: uppercase;
      }
      header {
        border-bottom: 2px white solid;
      }
      body {
        background: rgb(153, 153, 153);
      }
      .container {
        margin: auto;
        max-width: 500px;
      }
      path {
        fill: white;
      }
      .department {
        height: 180px;
      }
      svg {
        height: 100%;
        margin: auto;
        display: block;
      }
      .answers {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .answers > * {
        border-radius: 4px;
        height: 32px;
      }
      .answer {
        background: rgb(84, 84, 84);
      }
      input[type="text"] {
        height: 32px;
        border-radius: 4px;
        color: black;
        padding: 5px 10px;
      }
      input[type="submit"] {
        background: red;
      }
      .input-group {
        display: flex;
        flex-direction: column;
        position: relative;
      }
      #suggestions {
        position: absolute;
        display: flex;
        flex-direction: column;
        width: 100%;
        gap: 4px;
        bottom: calc(32px + 4px);
        max-height: 200px;
        overflow: auto;
      }
      #suggestions > * {
        display: block;
        background: rgb(153, 153, 153);
        height: 32px;
        border-radius: 4px;
        padding: 5px 10px;
        border: solid white 2px;
        font-weight: 500;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Departle</h1>
      </header>
      <div class="department">
        <svg viewBox="0 0 667 578" xml:space="preserve">
          <path id="department"></path>
        </svg>
      </div>
      <form class="answers">
        <div class="answer"></div>
        <div class="answer"></div>
        <div class="answer"></div>
        <div class="answer"></div>
        <div class="answer"></div>
        <div class="answer"></div>
        <div class="input-group">
          <div id="suggestions"></div>
          <input type="text" id="answer" placeholder="Département" />
        </div>
        <input type="submit" value="Deviner" />
      </form>
    </div>
    <script>
      "use strict";

      let isReady = false;
      let answers = [];
      let departments = [];
      let departmentNames = [];
      let department = null;

      const inputElement = document.getElementById("answer");
      const suggestionsElement = document.getElementById("suggestions");
      const formElement = document.getElementsByTagName("form")[0];

      async function fetchData() {
        const response = await fetch("departments.json");
        departments = (await response.json()).sort((a, b) =>
          a.name.localeCompare(b.name)
        );
        departmentNames = departments.map((d) => d.name);
        department =
          departments[Math.round(Math.random() * departments.length)];
        document
          .getElementById("department")
          .setAttribute("d", department.originalPath);
        isReady = true;
      }

      function guess(e) {
        e.preventDefault();
        if (!isReady) {
          return;
        }
        const answer = inputElement.value;
        inputElement.value = "";
        if (!departmentNames.includes(answer)) {
          return alert("Département inconnu !");
        } else {
          answers.push(answer);
          document.getElementsByClassName("answer")[
            answers.length - 1
          ].innerHTML = answer;
          if (answer === department.name) {
            alert("Vous avez gagné !");
          } else {
            if (answers.length === 6) {
              alert("Vous avez perdu...");
            }
          }
        }
      }

      function resetSuggestions() {
        suggestionsElement.innerHTML = "";
      }

      function autocomplete() {
        resetSuggestions();

        const answerLowerCase = inputElement.value.toLowerCase();
        departmentNames
          .filter((d) => d.toLowerCase().includes(answerLowerCase))
          .forEach((d) => {
            const element = document.createElement("div");
            element.appendChild(document.createTextNode(d));
            element.addEventListener("click", () => (inputElement.value = d));
            suggestionsElement.appendChild(element);
          });
      }

      fetchData();

      document.addEventListener("click", (e) => {
        e.target !== inputElement && resetSuggestions();
      });
      inputElement.addEventListener("keyup", autocomplete);
      inputElement.addEventListener("click", autocomplete);
      formElement.addEventListener("submit", guess);
    </script>
  </body>
</html>
